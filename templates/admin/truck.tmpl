<h1>Edit Truck</h1>

<label>Id</label><br>
<input type="text" data-bind="value: truck().id" disabled><br>

<label>Name</label><br>
<input type="text" data-bind="value: truck().name"><br>

<label>Twitname</label><br>
<input type="text" data-bind="value: truck().twitname"><br>

<label>Web Url</label><br>
<input type="text" data-bind="value: truck().weburl"><br>

<label>Type</label><br>
<input type="text" data-bind="value: truck().type"><br>

<label>About</label><br>
<input type="text" data-bind="value: truck().about"><br>

<label>Foursquare</label><br>
<input type="text" data-bind="value: truck().foursquare"><br>

<label>Matcher</label><br>
<input type="text" data-bind="value: truck().matcher"><br>

<label>Match Method</label><br>
<input type="text" data-bind="value: truck().matchmethod"><br>

<button data-bind="click: save">Save</button>

<table class="table table-minimal">
	<thead>
		<tr>
			<th>Image</th>
			<th>Menu</th>
			<th></th>
		</tr>
	</thead>
	<tbody data-bind="foreach: truckImages">
		<tr>
			<td>
				<div data-bind="css: visibility">
					<img data-bind="attr { src: 'http://irs0.4sqi.net/img/general/width60'+ suffix}, click: $parent.editImage" style="cursor: pointer;"/>
				</div>
			</td>
			<td><span data-bind="text: menu"></span></td>
			<td><a data-bind="click: $parent.delete">delete</a></td>
		</tr>
	</tbody>
</table>

<button data-bind="click: getImages">Get Images</button>
<div data-bind="if: page().length">
	<div data-bind="foreach: page">
		<img data-bind="attr { src: prefix + 'width100'+ suffix}, click: $parent.addImage" style="cursor: pointer;"/>
	</div>
	<div>
		<button data-bind="click: prev, visible: hasPrevious">Prev</button>
		<button data-bind="click: next, visible: hasNext">Next</button>
	</div>
</div>

<script>
	document.addEventListener('DOMContentLoaded', function() {
		ko.applyBindings(new AdminEditTruck({{ .id }}));
	});
	
	function AdminEditTruck(id) {
		var self = this;
		self.truck = ko.observable({});
		self.truckImages = ko.observableArray([]);
		self.images = ko.observableArray([]);
		self.pageNumber = ko.observable(0);
		self.perPage = 10;
		
		$.ajax({
	    	dataType: 'json',
	    	url: API_URL + '/trucks/' + id,
	    	xhrFields: {
	      		withCredentials: true
	    	}
	  	}).done(function(data) {
	  		self.truck(data);
  			self.truckImages(data.images);
	  	});

		self.save = function() {
			$.ajax({
			    url: API_URL + '/trucks/' + id,
			    method: 'PUT',
			    data: ko.toJS(self.truck),
			    xhrFields: {
		      		withCredentials: true
		    	}
			}).done(function(data) {
				success();
			}).fail(function(data) {
				var json = data.responseJSON;
				error(json.errors);
			});
			return true;
		};

		self.delete = function(image) {
			$.ajax({
			    url: API_URL + '/images/' + image.id,
			    type: 'DELETE',
			    xhrFields: {
		      		withCredentials: true
		    	}
			}).done(function(data) {
				self.truckImages.remove(image);
			}).fail(function(data) {

			});
		};

		self.getImages = function() {
			$.ajax({
		    	dataType: 'json',
		    	url: '/admin/foursquare/' + self.truck().foursquare,
		    	xhrFields: {
		      		withCredentials: true
		    	}
		  	}).done(function(data) {
		  		self.images(data);
		  	});
		};

		self.totalPages = ko.computed(function() {
			var div = Math.floor(self.images().length / self.perPage);
			div += self.images().length % self.perPage > 0 ? 1 : 0;
			return div - 1;
		});

		self.paginated = ko.computed(function() {
			var first = self.pageNumber() * self.perPage;
			return self.images().slice(first, first + self.perPage);
		});

		self.hasPrevious = ko.computed(function() {
			return self.pageNumber() !== 0;
		});

		self.hasNext = ko.computed(function() {
			return self.pageNumber() !== self.totalPages;
		});

		self.next = function() {
			if(self.pageNumber() < self.totalPages()) {
				self.pageNumber(self.pageNumber() + 1);
			}
		};

		self.prev = function() {
			if(self.pageNumber() !== 0) {
				self.pageNumber(self.pageNumber() - 1);
			}
		};

		self.page = ko.computed(function() {
			if(self.images().length < self.perPage) {
				self.pageNumber(0);
			}
			var first = self.pageNumber() * self.perPage;
			return self.images.slice(first, first + self.perPage);
		});

		self.addImage = function(image) {
			$.ajax({
				url: API_URL + '/images',
				method: 'POST',
				data: {
					id: image.id,
					suffix: image.suffix,
					twitname: self.truck().twitname
				},
				xhrFields: {
		      		withCredentials: true
		    	}
			}).done(function(data) {
				self.truckImages.push(data);
			}).fail(function(data) {
				
			});
		};

		self.editImage = function(image) {
			window.location.assign('/admin/image/' + image.id);
		};
	}
</script>