<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js" ></script>
    <style type="text/css">

    </style>
    <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAN8Jk0062QBOMPmXH-Totg9zi1GCw3o3w">
    </script>
    <script type="text/javascript">
      var markers = new Array;
      var infoWindow = new google.maps.InfoWindow({
      	content: '',
      });
      function initialize() {
        var beaches = [];
        $.ajax({
          url: "/updatedTrucks",
        })
        .done(function( msg ) {
          beaches = msg;
          var mapOptions = {
            center: { lat: 40.755575, lng: -73.982404},
            zoom: 12
          };
          var map = new google.maps.Map(document.getElementById('map-canvas'),
              mapOptions);

          google.maps.event.addListener(map, 'click', function() {
        	  
          });

          setMarkers(map, beaches);
        });


      }

      function getMarkerAt(latLng) {
      	for(var j=0; j < markers.length; j++) {
            	if(latLng.k === markers[j].position.k && latLng.d === markers[j].position.d) {
            		return markers[j];
            	}
            }
      }

      function setMarkers(map, locations) {
        for (var i = 0; i < locations.length; i++) {
            var loc = locations[i];
            var infowindow = new google.maps.InfoWindow({
                content: loc.name,
            });
            var myLatLng = new google.maps.LatLng(loc.lat, loc.long);
            
            var existingMarker = getMarkerAt(myLatLng);

            if(existingMarker != null) {
            	existingMarker.title += '<a href="/truck/'+ loc.id + '" />' + loc.name + '</a><br>';
            	
            } else {
	            var marker = new google.maps.Marker({
	                position: myLatLng,
	                map: map,
	                title: '<a href="/truck/'+ loc.id + '" />' + loc.name + '</a><br>',
	                zIndex: 1,
	                display: loc.display,
	                id: loc.id,
	            });

	            markers.push(marker);

	            google.maps.event.addListener(marker, 'click', function() {
	            	if(infoWindow.getContent() != '') {
	            		infoWindow.setContent('');
	            		infoWindow.close();
	            	}

            		infoWindow.setContent('<h3>' + this.display + '</h3>' + this.title);
            		infoWindow.open(map, this);
	            });
	        }
        }
      }

      google.maps.event.addDomListener(window, 'load', initialize);
    </script>
  </head>
  <body>
  <div class="container">
    <div class="col-xs-12">
        <div id="map-canvas" style="height:500px"></div>
    </div>
   <div class="col-xs-6">
   Now the map is on the top of the page
    </div>
    <div class="col-xs-6">
   Bootstrap!
    </div>
  </div>

  </body>
</html>
